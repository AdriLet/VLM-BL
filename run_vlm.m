function result=run_vlm( Vs, TWSRef, Lambda, AWA,Head,Main)
%speed in m/s and angles in degrees
% VLM
% Code written by Julien Pilate. 
% Property of North Sails

% 21/5/2014: Update the code for Adrien
% 22/3/2011: Reads _V but if _H is present use Z_H2V
% 9/3/2011: Function run_vlm in the folder
% 8/3/2011: Divide the gamma_chord/AWRef
% 4/3/2011: Va becomes AW- Include windshear in get_wake
% 2/3/2011: change the outputs  format- Add the object WindProfile
% 1/3/2011: reads the _H as input
% 8/2/2011: loading function return object.
% 19/1/2011: function return object, sail->Sail, dCp from Joukowski method
% 10/12/2010: Joukowski method can be used
% 15/12/2010: Va is an object



%--------------------------------------------------------------------------
%% 1 Inputs
%--------------------------------------------------------------------------
% The boat is on starboard tack, x points the stern, Y down, Z port.
%--------------------------------------------------------------------------
%
%1.1 General Parameters
% TWSRef=5;       %[m/s]
% AWA=46;         %[deg]
% Lambda=2;       %[deg]
% Vs=2;           %[m/s]

rho=1.205;      %[kg/m^3]
mirror=1;       % Mirror plane on/off
Windshear=1;    % WindShear  on/off

AWS= Vs*cos((Lambda+AWA)/180*pi)+(TWSRef^2-(Vs*sin((Lambda+AWA)/180*pi))^2)^0.5;     % Apparent Wind Speed at 10 m above the water [m/s]
TWA= 180-acos((Vs^2+TWSRef^2-AWS^2)/(2*Vs*TWSRef))*180/pi-Lambda;                    % True Wind Angle [deg]                                                               % True Wind Speed at 10 m above the water [m/s]
    
%1.2 The points of the HeadSail + MainSail

% Head.X=[-6.18228100000000,-6.07708900000000,-5.82946700000000,-5.50645700000000,-5.10457700000000,-4.62290000000000,-4.06965400000000,-3.45995300000000,-2.81504600000000,-2.16242800000000,-1.53167400000000,-0.950877000000000,-0.443064000000000,-0.0223630000000000,0.306674000000000,0.551604000000000,0.654972000000000;-6.16434700000000,-6.06087900000000,-5.81622900000000,-5.49489500000000,-5.09373000000000,-4.61293000000000,-4.06103700000000,-3.45290600000000,-2.80951000000000,-2.15830300000000,-1.52867100000000,-0.949112000000000,-0.442221000000000,-0.0215100000000000,0.307436000000000,0.552046000000000,0.655292000000000;-6.09281100000000,-5.99529200000000,-5.76133000000000,-5.44692900000000,-5.04955100000000,-4.57277700000000,-4.02635900000000,-3.42451200000000,-2.78721300000000,-2.14164100000000,-1.51648400000000,-0.941720000000000,-0.438351000000000,-0.0178600000000000,0.310516000000000,0.553833000000000,0.656559000000000;-5.95053000000000,-5.86165300000000,-5.64486800000000,-5.34491800000000,-4.95818000000000,-4.49126800000000,-3.95607800000000,-3.36684600000000,-2.74191700000000,-2.10756300000000,-1.49132500000000,-0.925589000000000,-0.428729000000000,-0.00968500000000000,0.316804000000000,0.557485000000000,0.659045000000000;-5.73905000000000,-5.65710500000000,-5.45790400000000,-5.17984300000000,-4.81421800000000,-4.36560000000000,-3.84808000000000,-3.27793300000000,-2.67182200000000,-2.05412400000000,-1.45128800000000,-0.897962000000000,-0.410026000000000,0.00450500000000000,0.326574000000000,0.563113000000000,0.662678000000000;-5.46059600000000,-5.38224200000000,-5.19733300000000,-4.94555500000000,-4.61104200000000,-4.19063600000000,-3.69858500000000,-3.15432200000000,-2.57330800000000,-1.97737800000000,-1.39273700000000,-0.854575000000000,-0.378282000000000,0.0263140000000000,0.340275000000000,0.570786000000000,0.667402000000000;-5.11796600000000,-5.04329600000000,-4.87111200000000,-4.64359000000000,-4.34310200000000,-3.95936400000000,-3.50204000000000,-2.99082700000000,-2.44060800000000,-1.87132800000000,-1.31042900000000,-0.790491000000000,-0.330328000000000,0.0568890000000000,0.358461000000000,0.580471000000000,0.673207000000000;-4.71437700000000,-4.64614900000000,-4.48796900000000,-4.28011900000000,-4.01060400000000,-3.66751100000000,-3.25256200000000,-2.78100400000000,-2.26722800000000,-1.73080000000000,-1.20044500000000,-0.703934000000000,-0.266368000000000,0.0965170000000000,0.381423000000000,0.592085000000000,0.680054000000000;-4.25351400000000,-4.19266100000000,-4.05030500000000,-3.86247100000000,-3.62153900000000,-3.31723600000000,-2.94666300000000,-2.51949900000000,-2.04863400000000,-1.55404400000000,-1.06240900000000,-0.598126000000000,-0.190563000000000,0.144514000000000,0.408973000000000,0.605547000000000,0.687843000000000;-3.74018500000000,-3.68662200000000,-3.56167800000000,-3.39686000000000,-3.18475000000000,-2.91643500000000,-2.58918800000000,-2.20962900000000,-1.78792100000000,-1.34342400000000,-0.898493000000000,-0.475962000000000,-0.105104000000000,0.199927000000000,0.440782000000000,0.620796000000000,0.696473000000000;-3.17999900000000,-3.13452600000000,-3.02815600000000,-2.88747200000000,-2.70620900000000,-2.47523600000000,-2.19202800000000,-1.86283200000000,-1.49479700000000,-1.10464200000000,-0.712416000000000,-0.338233000000000,-0.00900600000000000,0.262026000000000,0.476521000000000,0.637757000000000,0.705861000000000;-2.57818500000000,-2.54136600000000,-2.45472200000000,-2.33971300000000,-2.19178000000000,-2.00112100000000,-1.76459600000000,-1.48834200000000,-1.17688700000000,-0.844127000000000,-0.508571000000000,-0.186958000000000,0.0966380000000000,0.330053000000000,0.515728000000000,0.656241000000000,0.715904000000000;-1.94055300000000,-1.91257200000000,-1.84702100000000,-1.76008900000000,-1.64777200000000,-1.49994100000000,-1.31295400000000,-1.09213400000000,-0.839626000000000,-0.567266000000000,-0.291045000000000,-0.0247880000000000,0.209889000000000,0.403076000000000,0.557854000000000,0.676006000000000,0.726490000000000;-1.27454700000000,-1.25586900000000,-1.21270000000000,-1.15554900000000,-1.08088200000000,-0.978137000000000,-0.842880000000000,-0.679729000000000,-0.488307000000000,-0.278275000000000,-0.0633350000000000,0.145772000000000,0.329337000000000,0.479998000000000,0.602300000000000,0.696806000000000,0.737517000000000;-0.588250000000000,-0.579259000000000,-0.559526000000000,-0.533660000000000,-0.498286000000000,-0.442221000000000,-0.360314000000000,-0.256420000000000,-0.127491000000000,0.0189310000000000,0.171387000000000,0.322084000000000,0.452996000000000,0.559728000000000,0.648502000000000,0.718395000000000,0.748867000000000;0.109846000000000,0.108259000000000,0.103493000000000,0.0973350000000000,0.0924830000000000,0.101031000000000,0.128632000000000,0.172323000000000,0.238032000000000,0.320319000000000,0.409934000000000,0.501646000000000,0.578911000000000,0.641142000000000,0.695940000000000,0.740508000000000,0.760435000000000;0.460725000000000,0.453469000000000,0.436158000000000,0.414016000000000,0.388959000000000,0.373639000000000,0.373942000000000,0.387357000000000,0.421334000000000,0.471557000000000,0.529758000000000,0.591928000000000,0.642205000000000,0.682122000000000,0.719897000000000,0.751658000000000,0.766263000000000;];
% Head.Y=[1.47304286948789,1.75875037475581,2.42324391775585,3.28722525143084,4.37079139216678,5.67710709559553,7.18994127020651,8.87579775055236,10.6784704357464,12.5191573071296,14.3099138378906,15.9656729332947,17.4176069140500,18.6227136699579,19.5659706012695,20.2586558363029,20.5452417869985;1.47327529314536,1.75906533457794,2.42383337485588,3.28802067180496,4.37146088356900,5.67759005556647,7.19043213900397,8.87640428329801,10.6791655146173,12.5199021039142,14.3106126325066,15.9664052916130,17.4182784806519,18.6230270217265,19.5660295374224,20.2585974538599,20.5451220036092;1.47423175874771,1.76024857344286,2.42586369500482,3.29080318989048,4.37399787830160,5.67962730410801,7.19254896209325,8.87896727221818,10.6820766488576,12.5229728451198,14.3134667893691,15.9692907634796,17.4208311626941,18.6242232082210,19.5662620222741,20.2583528055959,20.5446438266707;1.47627107950684,1.76239591621897,2.42886746994417,3.29502016519647,4.37855877521858,5.68402886704130,7.19729691903076,8.88457301071720,10.6883396014879,12.5294175978587,14.3193212781135,15.9748438602593,17.4254307904035,18.6263924386015,19.5667068017192,20.2578399688839,20.5437102764926;1.47969783274007,1.76538712549802,2.43163541816289,3.29895668893079,4.38436178892076,5.69112794418116,7.20537140176082,8.89389655317993,10.6985299750989,12.5395389019376,14.3282407467307,15.9825391922544,17.4311448823374,18.6291435470828,19.5673024999931,20.2570187004852,20.5423470049689;1.48509356435887,1.76980310468232,2.43449632385780,3.30234516410546,4.39078958337728,5.70065325661238,7.21702249773422,8.90728700777847,10.7127753208593,12.5530755262930,14.3397648428793,15.9913626269897,17.4368149719447,18.6320247245411,19.5679156296683,20.2558638789392,20.5405747076093;1.49330133459165,1.77715008437545,2.44016213786275,3.30748460756686,4.39791359236992,5.71151023147920,7.23153409872480,8.92418787267269,10.7301918996929,12.5688044265434,14.3526646644051,15.9999338956154,17.4414415275795,18.6346637883794,19.5683473204771,20.2543705584232,20.5384001132366;1.50499373628108,1.78849290380755,2.45066267229701,3.31677346894552,4.40692822980736,5.72322196428863,7.24754012682315,8.94283277064858,10.7488146945238,12.5851017529639,14.3656458356099,16.0076730993288,17.4450943694224,18.6368903857520,19.5684389995437,20.2525513769732,20.5358318422499;1.52039876338475,1.80362392585940,2.46539735287393,3.33078588674733,4.41988809329058,5.73678648107752,7.26367534543174,8.96066656874426,10.7661299755659,12.6005233089830,14.3778937224850,16.0153092633378,17.4490870150505,18.6387680536889,19.5681459613970,20.2504089696912,20.5329111881927;1.53967080464292,1.82242388162865,2.48381556122579,3.34916617995510,4.43744190374586,5.75322241126054,7.27996019832385,8.97686107760086,10.7812410733000,12.6141403240570,14.3888311366060,16.0230172068001,17.4536859183703,18.6403199925648,19.5674299226096,20.2479257597595,20.5296744665632;1.56310320030235,1.84525752336029,2.50613878506453,3.37122381586305,4.45845518424796,5.77263510685789,7.29755852459733,8.99264693799341,10.7951011668528,12.6258159538119,14.3981385340480,16.0299484568896,17.4577515505218,18.6413881171529,19.5662251247888,20.2450831306170,20.5261541122313;1.59108306119338,1.87226560726313,2.53205210356249,3.39644703519166,4.48224510213267,5.79438965057062,7.31658625348025,9.00862500009066,10.8081649698499,12.6359927893812,14.4058766629354,16.0356310645878,17.4608753779361,18.6417907730709,19.5645021361397,20.2418949151928,20.5223893971966;1.62408606133552,1.90374391837226,2.56138418265248,3.42448795748442,4.50842140872090,5.81776035953731,7.33646581171932,9.02468301102363,10.8205211247749,12.6451158812660,14.4122838867462,16.0399770702610,17.4630366647627,18.6414571697274,19.5622568699825,20.2383978873933,20.5184185501947;1.66114928458838,1.93921815797443,2.59406222376276,3.45490437393242,4.53628730275652,5.84219677484781,7.35679564854022,9.04065805832135,10.8323077959961,12.6532875817032,14.4175533863994,16.0431303579642,17.4642013550527,18.6404453145510,19.5595483480383,20.2346320050703,20.5142858212704;1.69883108664029,1.97598283055903,2.62893445367066,3.48726084486987,4.56525083304421,5.86715442533242,7.37718275234781,9.05623041447591,10.8433402599951,12.6604927323640,14.4217712719292,16.0453657028032,17.4646317916587,18.6388160845575,19.5564034853296,20.2306425325612,20.5100293850061;1.73095096223086,2.01034578931873,2.66484386576966,3.52080674984707,4.59502712651183,5.89234140258637,7.39727521825650,9.07117899876347,10.8535432035612,12.6668078058784,14.4250637999401,16.0468387669184,17.4644083595228,18.6364845413291,19.5527869581815,20.2264670414516,20.5056951447482;1.74463265941478,2.02648305325307,2.68299024393114,3.53773340565817,4.61010682107425,5.90497896474702,7.40720290633724,9.07848744647414,10.8584518109680,12.6697635786965,14.4265100479366,16.0474038937956,17.4641201760172,18.6351257436764,19.5508584861198,20.2243378053719,20.5035121392796;];
% Head.Z=[-0.00577336755029904,0.00269772798580535,0.0179847198825781,0.0358652791355844,0.0601099629158251,0.0859702163072431,0.109647609979732,0.127522717276551,0.135828066484577,0.133419068471682,0.121831310719516,0.104194309705723,0.0832186737234443,0.0622663412676115,0.0444101972682359,0.0324632571261400,0.0285061095591148;-0.00158063893477330,0.0100787496840830,0.0298420311430295,0.0483643973216180,0.0712313641882528,0.0962125862803729,0.119419866721328,0.136524676120517,0.143772004258954,0.140136395823365,0.127256060491135,0.108470628600936,0.0864065871945613,0.0642360629913762,0.0454196181566070,0.0328899144715032,0.0287114189345562;0.0151689843311850,0.0375165437424352,0.0731635823859479,0.0955780300467506,0.114889447548918,0.136849905045026,0.157986202170898,0.172057001344109,0.175253321233228,0.166871705779456,0.148860415251326,0.125487375120386,0.0990126793484080,0.0720025630313144,0.0494333356097566,0.0345856636354206,0.0295286458402734;0.0485188532191036,0.0851790821662526,0.145421287671362,0.179758294867365,0.198598959859722,0.216466903008678,0.233021179707507,0.241250345907589,0.236984110029028,0.219626999117038,0.191530510007979,0.158982195991011,0.123513299380048,0.0870619521144198,0.0573509827504941,0.0379274140011402,0.0311448516022498;0.0979666394918839,0.142981075670361,0.225729019277095,0.283841764553425,0.313981876974745,0.330463701598649,0.340310020565454,0.340505187401321,0.326246977105246,0.296326877400786,0.253571545174926,0.207167676693040,0.158022436059635,0.108385406481017,0.0688612060570366,0.0428005947096003,0.0335277565001891;0.162266971577324,0.206016944957964,0.301323467642070,0.390324310681843,0.445775989872191,0.468936658063395,0.473488642857542,0.464751447375794,0.438383267752693,0.392334897993134,0.330983272044689,0.265697546028880,0.198625406737228,0.134238717805755,0.0832734107808610,0.0490094663620727,0.0366491347324900;0.239112583246475,0.279285669761858,0.377540573515105,0.488115382881237,0.572877287056259,0.615311655223912,0.622856233524629,0.606374706503055,0.565666100242902,0.499620836274506,0.416856595199211,0.327537340628693,0.239738709510882,0.162298780814541,0.0994926865984065,0.0562820665735883,0.0404839119508542;0.325323003328580,0.365628883839924,0.461553773433896,0.575396897718504,0.680636973033305,0.749933705440808,0.770685548332332,0.749838184533070,0.694531961465679,0.607958679822106,0.503408077059155,0.387529038645017,0.278852440967638,0.190687330374894,0.116543693751907,0.0644002456706495,0.0449969927321937;0.417295551188988,0.458156431908954,0.550266390384904,0.658457005714748,0.768729776073601,0.855811002805654,0.892032910666471,0.871599174388124,0.806460990526202,0.706535436022274,0.583751136728899,0.445024706249005,0.318592528862460,0.218622632487431,0.133899885547476,0.0732379677209299,0.0501229260011857;0.512018378040511,0.551581295628812,0.639100119396510,0.739450685527411,0.841742939157391,0.928841274275908,0.972997283765276,0.957148794912668,0.890224240333445,0.785959613232210,0.652054683528055,0.499083394843736,0.359184100527712,0.245661409877053,0.151073648019776,0.0825574091438483,0.0557983147185092;0.605828091944027,0.643293371400060,0.723205277160142,0.811777028917303,0.901392850092278,0.977273862670960,1.01854335367665,1.00829382342637,0.946202409656043,0.842091450756253,0.705130991357990,0.546896129195545,0.396891278693257,0.271150336391606,0.167533662212081,0.0920247519895439,0.0619708045223031;0.691254062055690,0.724959645980800,0.794465798442429,0.869367222619884,0.944928743066225,1.00702899180613,1.04085157923491,1.03341924413163,0.978336804815329,0.878399358473394,0.743787449632404,0.586438902109794,0.430097393224858,0.294291332658225,0.182963228314700,0.101439834698097,0.0685729661158746;0.758753576799265,0.786402318861441,0.844265033509431,0.906509699408204,0.967805578148880,1.01832453408591,1.04670461376577,1.04044273719966,0.991856772473184,0.899409781683354,0.770087597750586,0.616792612339163,0.458180632234155,0.314550134049452,0.197077373874498,0.110689252332193,0.0755333812678061;0.803076757270761,0.822241211445444,0.867451468664383,0.919402025670837,0.969029843886131,1.01093643820315,1.03577678722817,1.03158919757781,0.989638984944508,0.905985662458115,0.784970398508664,0.638776749589938,0.480951353446453,0.331927112328258,0.209785454330574,0.119676566465422,0.0827825666454033;0.822797795126839,0.831706580891311,0.864421601629279,0.908559947757718,0.948239930291456,0.983531522945333,1.00585322628803,1.00420793265460,0.970140352399864,0.897743142457838,0.787983892769082,0.653015374469155,0.499270766027873,0.346133591224457,0.220710156044725,0.128241277441223,0.0902441043105150;0.805438897464652,0.812404275166889,0.836566045115280,0.870052364812789,0.903694820612275,0.934734869230050,0.955559661702605,0.958477347344566,0.933424694274379,0.875279428461510,0.779612741516258,0.659291788342739,0.512896985168950,0.355975420636426,0.228990811114677,0.136158965171474,0.0978164911460306;0.784562491160710,0.794798465281692,0.816282318124891,0.842691433120824,0.875331833958818,0.905080256728189,0.925377367979768,0.931518610800353,0.911110221990115,0.860746563085150,0.772887683246435,0.660500738553702,0.518421430414138,0.359602350045570,0.232373896172314,0.139934247639949,0.101613357238515;];
% Main.X=[0.324226000000000,0.329823000000000,0.342522000000000,0.358762000000000,0.379678000000000,0.406467000000000,0.440688000000000,0.484109000000000,0.537915000000000,0.602027000000000,0.674632000000000,0.751959000000000,0.828702000000000,0.899248000000000,0.958977000000000,1.00570000000000,1.04825800000000,1.09490400000000,1.14495100000000,1.19874900000000,1.25627600000000,1.31697000000000,1.34801200000000;0.368551000000000,0.372845000000000,0.383615000000000,0.398803000000000,0.418576000000000,0.443693000000000,0.475793000000000,0.516941000000000,0.568174000000000,0.629408000000000,0.699164000000000,0.773742000000000,0.848093000000000,0.916789000000000,0.975180000000000,1.02092300000000,1.06258300000000,1.10826300000000,1.15730900000000,1.20990600000000,1.26596500000000,1.32511600000000,1.35540100000000;0.543893000000000,0.544333000000000,0.548064000000000,0.557621000000000,0.572257000000000,0.590485000000000,0.613757000000000,0.645608000000000,0.687018000000000,0.737579000000000,0.796256000000000,0.860132000000000,0.925229000000000,0.986796000000000,1.03989600000000,1.08166800000000,1.11966000000000,1.16140100000000,1.20640200000000,1.25422100000000,1.30449100000000,1.35755300000000,1.38483900000000;0.888548000000000,0.884493000000000,0.876944000000000,0.873075000000000,0.874968000000000,0.878612000000000,0.884038000000000,0.897052000000000,0.919619000000000,0.950176000000000,0.987629000000000,1.03128200000000,1.07887000000000,1.12642000000000,1.16878500000000,1.20255200000000,1.23312000000000,1.26678600000000,1.30348800000000,1.34174100000000,1.38066200000000,1.42175700000000,1.44310200000000;1.39436100000000,1.38629600000000,1.36709200000000,1.34500900000000,1.32473800000000,1.30507700000000,1.28501000000000,1.27034600000000,1.26427900000000,1.26467800000000,1.27162500000000,1.28652000000000,1.30876900000000,1.33514600000000,1.36104300000000,1.38270800000000,1.40198100000000,1.42314800000000,1.44693900000000,1.47069400000000,1.49285100000000,1.51626300000000,1.52875600000000;2.05092900000000,2.03781300000000,2.00688300000000,1.96726200000000,1.92132500000000,1.87183600000000,1.81991300000000,1.76939500000000,1.72346100000000,1.68252900000000,1.64930400000000,1.62665900000000,1.61542200000000,1.61329500000000,1.61661800000000,1.62132800000000,1.62476600000000,1.62859000000000,1.63466400000000,1.63886600000000,1.63877500000000,1.63884900000000,1.63965800000000;2.84309500000000,2.82386500000000,2.77939400000000,2.72220700000000,2.65205200000000,2.57100700000000,2.48194800000000,2.38810700000000,2.29358900000000,2.20276900000000,2.12084000000000,2.05268600000000,1.99983700000000,1.96054700000000,1.93356300000000,1.91574000000000,1.89854000000000,1.88003800000000,1.86348600000000,1.84308500000000,1.81539800000000,1.78665800000000,1.77303100000000;3.75125700000000,3.72553100000000,3.66581100000000,3.58862200000000,3.49275700000000,3.37858700000000,3.24851800000000,3.10673200000000,2.95940900000000,2.81369700000000,2.67655300000000,2.55478400000000,2.45214800000000,2.36839500000000,2.30492200000000,2.25976300000000,2.21763200000000,2.17232100000000,2.12865900000000,2.07902300000000,2.01884500000000,1.95621200000000,1.92556600000000;4.75189400000000,4.71896200000000,4.64237600000000,4.54282300000000,4.41795900000000,4.26735700000000,4.09350100000000,3.90158600000000,3.69888400000000,3.49405400000000,3.29597400000000,3.11404200000000,2.95555900000000,2.82306100000000,2.71976700000000,2.64392700000000,2.57353300000000,2.49788400000000,2.42348500000000,2.34077100000000,2.24402100000000,2.14332800000000,2.09358000000000;5.81809400000000,5.77712100000000,5.68194700000000,5.55793800000000,5.40152100000000,5.21225100000000,4.99283600000000,4.74855800000000,4.48749300000000,4.21989100000000,3.95748300000000,3.71266500000000,3.49543900000000,3.31109200000000,3.16516500000000,3.05640700000000,2.95569200000000,2.84738900000000,2.73961200000000,2.62092700000000,2.48463400000000,2.34313200000000,2.27300100000000;6.92140200000000,6.87183800000000,6.75659500000000,6.60652900000000,6.41759700000000,6.18872300000000,5.92225500000000,5.62347000000000,5.30137400000000,4.96920300000000,4.64120700000000,4.33191900000000,4.05504500000000,3.81747700000000,3.62696400000000,3.48410400000000,3.35224800000000,3.21037000000000,3.06779300000000,2.91095100000000,2.73267600000000,2.54966200000000,2.45957600000000;7.47875900000000,7.42480400000000,7.29916600000000,7.13574000000000,6.93059000000000,6.68180800000000,6.39143300000000,6.06498500000000,5.71188900000000,5.34719300000000,4.98616900000000,4.64428900000000,4.33763500000000,4.07332100000000,3.86010500000000,3.70004700000000,3.55259600000000,3.39388700000000,3.23369600000000,3.05726400000000,2.85738700000000,2.65376600000000,2.55412100000000;];
% Main.Y=[3.38844650099997,3.64737973846257,4.24738693168629,5.02432091427090,5.99753217289161,7.17120980031286,8.53346318776133,10.0527788203414,11.6743218167396,13.3261743082374,14.9297887594882,16.4107883910413,17.7085788800982,18.7847984884742,19.6267856674867,20.2459703072098,20.7741531829929,21.3170131832420,21.8596366558001,22.4019182821754,22.9437919760731,23.4852559287728,23.7558893621620;3.38704878983648,3.64429769634494,4.24296437678555,5.02066990658360,5.99404769294199,7.16812765067596,8.53113334817771,10.0508973297646,11.6729722080446,13.3252308273584,14.9292515577853,16.4105865013810,17.7086784883269,18.7851142202349,19.6272400650978,20.2465061611910,20.7746584565907,21.3173963979346,21.8598850073019,22.4020001479160,22.9436437570203,23.4847915324948,23.7552400809825;3.37747544008085,3.63087466143234,4.22630228753107,5.00582494493086,5.98041995910771,7.15623579795560,8.52175353466456,10.0435002802661,11.6675644190732,13.3214745101702,14.9270601328381,16.4097578646367,17.7090186392566,18.7862799970097,19.6289370985785,20.2485230784471,20.7765597489135,21.3188166962902,21.8607690658111,22.4022348039748,22.9429727914285,23.4828731564740,23.7525957889821;3.35046430827966,3.60217812424684,4.19576438679090,4.97631615483047,5.95387058838499,7.13333303703120,8.50298845681309,10.0289692424453,11.6567133192320,13.3138999920651,14.9224900477886,16.4078763421966,17.7093452472865,18.7881674033313,19.6318312999424,20.2520177539700,20.7798324921900,21.3211805828198,21.8621376782423,22.4023498872121,22.9413321623615,23.4788690633183,23.7472444894658;3.30609592561970,3.55927332997046,4.15395271758208,4.93471938862605,5.91549721917980,7.10001384759042,8.47544966995655,10.0074691200606,11.6403311005778,13.3021943843209,14.9150979157496,16.4043185823744,17.7088622235032,18.7898416048313,19.6348978048952,20.2559023241788,20.7834207749270,21.3235844092277,21.8632501304116,22.4017202046883,22.9381875997867,23.4725913136102,23.7392698016849;3.25000926171284,3.50508985470246,4.10246363933775,4.88486124820557,5.86857776754911,7.05841609963063,8.44064964777305,9.97937537006448,11.6183357900341,13.2859762502112,14.9042387887567,16.3981076872656,17.7063127202631,18.7899478161907,19.6368296549737,20.2589409878084,20.7861885249018,21.3250039865104,21.8632079998276,22.3995897060026,22.9330201276630,23.4639326128107,23.7288296329782;3.18585959208594,3.44272945457972,4.04340261104560,4.82902458723776,5.81678777438692,7.01182371022344,8.40023621372393,9.94545738216968,11.5909106321605,13.2649574525305,14.8891172105864,16.3880532887783,17.7003627485657,18.7873106867665,19.6366447518994,20.2602559177289,20.7873172234391,21.3246802598658,21.8613234026992,22.3954570723640,22.9256373351457,23.4530164684414,23.7161931619812;3.11781316283245,3.37643777237580,3.98049196094026,4.76976394643269,5.76210979602030,6.96224677597572,8.35608433621457,9.90729841542842,11.5591069394535,13.2395806806507,14.8698407239689,16.3742059941192,17.6911530118330,18.7818813857433,19.6340325956800,20.2594575544056,20.7864516285042,21.3223396304429,21.8574412942742,22.3893408930185,22.9162641947071,23.4401799241045,23.7017088188423;3.04978985674761,3.31015349374264,3.91769207151174,4.71068551406621,5.70733187936488,6.91222903963601,8.31101979508848,9.86754059164985,11.5251202078676,13.2116617573991,14.8479656583997,16.3579697953870,17.6798192452318,18.7744111469005,19.6294157965547,20.2567987771767,20.7838115680252,21.3182728729883,21.8519664588485,22.3817632321325,22.9054598704169,23.4258713168992,23.6857141169412;2.98414334952705,3.24613999989626,3.85704433778442,4.65374196738264,5.65455335567698,6.86380659810973,8.26706460082734,9.82836740654206,11.4912034749455,13.1833712120686,14.8253213568922,16.3407022301084,17.6673337719621,18.7657523185970,19.6236548976141,20.2531256758740,20.7802373163071,21.3133224896717,21.8457161845222,22.3734490336389,22.8938334245696,23.4105945084191,23.6686711326199;2.92135810123928,3.18511258543738,3.79965687234844,4.60018206275425,5.60491431477547,6.81814721761524,8.22558337000895,9.79136632363266,11.4589591451430,13.1561949173880,14.8032031182149,16.3234419833503,17.6546761148404,18.7567534253891,19.6174452837411,20.2491560345348,20.7765255211499,21.3082992203508,21.8392238599852,22.3642098019671,22.8806111928368,23.3948440488708,23.6524565770906;2.89064657733911,3.15537990448572,3.77194262678504,4.57449145156593,5.58111706531579,6.79624770356645,8.20571059652012,9.77363470883625,11.4434323519579,13.1430244595216,14.7923919131741,16.3149099318491,17.6484103652115,18.7522649113019,19.6142961335181,20.2471453049033,20.7746889862468,21.3058349475312,21.8359341733363,22.3592281877420,22.8733462657474,23.3869132334079,23.6449589782951;];
% Main.Z=[-0.0218123969589343,-0.0212537824805752,-0.0188531165740048,-0.0133675039183252,-0.00421048868998847,0.00768050348149098,0.0193590829410289,0.0287324391557059,0.0361084882322391,0.0417041609973989,0.0444181146329420,0.0436578641208831,0.0402757360614734,0.0355192866348325,0.0306067202425221,0.0263892935414373,0.0224094900930095,0.0180847034410039,0.0137124757578158,0.00954096226752979,0.00565488369759662,0.00188724984312344,-5.55111512312578e-17;-0.0169769752086140,-0.0128389083647527,-0.00604646622545678,-0.000145185556281201,0.00859800179408696,0.0206096435385757,0.0326820980845544,0.0419005892994870,0.0489858606882354,0.0545911353836165,0.0570516738832234,0.0558567662257894,0.0517803320213835,0.0460184828638429,0.0399663477891191,0.0347749817368579,0.0298184522059726,0.0243809222665654,0.0189140910388171,0.0137753239668320,0.00905168824192695,0.00443842919726428,0.00210115538454658;0.00381693013541413,0.0178842740019115,0.0407547402726197,0.0535827465231197,0.0618787242604930,0.0748856236391438,0.0894410167710358,0.0980729989390711,0.103232612373844,0.107025894257685,0.107898390794944,0.104737607934438,0.0975883347539305,0.0872632758747340,0.0765231119698462,0.0676260640140392,0.0590115722259963,0.0493300028424341,0.0395967292059485,0.0306387715839134,0.0225387463041827,0.0143857899247641,0.0101212652227184;0.0472540262954752,0.0699721316134604,0.116547931466710,0.153017178405700,0.169645592398281,0.186936247836602,0.206795138190899,0.214946234698379,0.214909687197810,0.212645126220788,0.208924813376564,0.200261588867538,0.185725966939024,0.166048455029048,0.146327860135464,0.130361894031576,0.114922405607783,0.0975032259074808,0.0799942756786376,0.0637924697313071,0.0488960613469656,0.0335112786766889,0.0253571169707273;0.107566102740741,0.133100521614327,0.196024441071576,0.264522239050204,0.312100556835615,0.343876321762956,0.369003915559667,0.377737643508681,0.372032333232574,0.363058727957263,0.351326227375578,0.332981906249798,0.306679292722256,0.273807642754910,0.241735243819193,0.215983843578949,0.191471031963842,0.164229104572364,0.136905565122569,0.111006058844181,0.0863473156812732,0.0608058717786745,0.0474037812262952;0.170593255173638,0.200474316200073,0.269883433933308,0.354247498385644,0.437236065156296,0.496377797617039,0.530676305450544,0.544384691814841,0.541641505142832,0.531637268774290,0.512582297112358,0.482138922909920,0.441079788566687,0.393671522832050,0.348906606562579,0.313252637980579,0.279516219544293,0.242109297544252,0.204294974038317,0.167662456641342,0.131942957159940,0.0950426593392132,0.0758825255345415;0.220367957993031,0.256635014606802,0.331969745517046,0.416811915980352,0.509904247280667,0.590124922604041,0.643036599987170,0.671985530280614,0.681840760902663,0.674974323456806,0.650737177053814,0.609480287693945,0.556897023764216,0.502531469687631,0.452326675117251,0.409632049393515,0.368027186455811,0.321817478868753,0.274790520271135,0.228379777071426,0.182229867182797,0.134698214336051,0.110254402901699;0.241471183619705,0.279367330713482,0.357733620620070,0.442095230881148,0.531253698180864,0.615513362721491,0.682712121135590,0.728886154549937,0.754151457201329,0.756475951029287,0.736386977804815,0.696503367251168,0.643484849971570,0.589508374095640,0.538840040794964,0.492792573838734,0.446550167056451,0.394713105005749,0.341279465872465,0.287672497056370,0.233603397724486,0.178112789014224,0.149818598493595;0.219836652095130,0.253478714854731,0.325952920930395,0.406828020853708,0.491209630544180,0.572782581597680,0.645697028874529,0.706404439459840,0.751313389529765,0.773992358836557,0.771584963717976,0.745508090316693,0.701181986292433,0.650741873274035,0.600652669301092,0.554134968091381,0.507312324561492,0.454587662522318,0.399400170935823,0.342773800012804,0.284321390484760,0.224022453452598,0.193420389088638;0.145819305839398,0.172898297037624,0.235083446216714,0.308476988525135,0.385544059238642,0.465346727207099,0.545923240646030,0.622301778072038,0.688183027382148,0.734485446948894,0.755337263504202,0.748873306855011,0.720041318391765,0.680073374504119,0.635594113080592,0.592277987424147,0.548949478230488,0.500651980274992,0.449451801237396,0.394597887939266,0.334940281552813,0.271857717094211,0.239771694544111;0.0205669651529112,0.0421735968755506,0.0932546717073272,0.157446219271986,0.230601595003112,0.312567287484801,0.401814057337708,0.492123888914426,0.576145683444553,0.644952532797519,0.690619022723000,0.708964905986885,0.702783396958732,0.677823706521193,0.643326820856567,0.610337040490092,0.576595300947698,0.537032519445399,0.492667652161639,0.441899729342258,0.383279322317039,0.319543101899392,0.286989078366020;-0.0538257721050285,-0.0344548730323566,0.0106539905185417,0.0696303148937322,0.142624174791141,0.226586430647786,0.319768480376719,0.416544501051652,0.509493939540999,0.590044957058023,0.648186626425282,0.679737599470889,0.686313293146446,0.669213815099751,0.640467760543709,0.614897085484263,0.587727844796687,0.553363166997493,0.512565448716833,0.463936976078465,0.406223352028179,0.342870366100187,0.310518662410401;];

MHead=20;       % Chordwise points
NHead=25;       % Spanwise points                                             
MMain=20;       % Chordwise points                                                  
NMain=30;       % Spanwise points  

% %1.3 Computation of the WindProfile
[WindProfile,AWRef]=get_WindProfile(TWSRef,TWA,Vs,Lambda,Windshear);

%--------------------------------------------------------------------------
%% 2 Generation of the points
%--------------------------------------------------------------------------
%2.1 The Head Sail
    %2.1.1 The Points for the vortex lines of the sail
    [Head.X_V,Head.Y_V,Head.Z_V] = get_FcosSp (Head.X,Head.Y,Head.Z,MHead,NHead);
%     Head.X_V=Head.X;
%         Head.Y_V=Head.Y;
%         Head.Z_V=Head.Z;


    %2.1.2 The control points
    [Head] = get_ControlPts (Head); 
    %2.1.3 The Normal at the panels
    [Head] = get_normal (Head);
    %2.1.4 The area of the panels
    [Head] = get_area (Head);
    %2.1.5 For each panel we project the Apparent wind on the normal vector.
    %Computation of the AW at _C. Computation of VaRef
    [Head] = get_AW_n (Head,TWSRef,TWA,Vs,Lambda,Windshear);
    %2.1.6 The Wake    
    [Head] = get_wake (Head,TWSRef,TWA,Vs,Lambda,Windshear);
    %2.1.7 Definition of the mirror of the Head Sail
    mirrorHead=Head;
    mirrorHead.Y_V=-Head.Y_V;
    mirrorHead.Y_C=-Head.Y_C;
    mirrorHead.wake_Y=-Head.wake_Y;
    mirrorHead.ny=-Head.ny;
Head.AWA=AWA;
Head.AWS=AWS;
Head.Bs=Vs;
Head.TWS=TWSRef;

%2.2 The Main Sail
    %2.2.1 The Points for the vortex lines and the control points of the sail
    [Main.X_V,Main.Y_V,Main.Z_V] = get_FcosSp (Main.X,Main.Y,Main.Z,MMain,NMain); 
    %2.2.2 The control points
    [Main] = get_ControlPts (Main);  
    %2.2.3 The Normal at the panels
    [Main] = get_normal (Main);
    %2.2.4 The area of the panels
    [Main] = get_area (Main);
    %2.2.5 For each panel we project the U inf onto the perpendicular of
    %the panel
    [Main] = get_AW_n (Main,TWSRef,TWA,Vs,Lambda,Windshear);
    %2.2.6 The Wake 
    [Main] = get_wake (Main,TWSRef,TWA,Vs,Lambda,Windshear);
   Main.AWA=AWA;
    Main.TWS=TWSRef;
    Main.Bs=Vs;
    Main.AWS=AWS;
    
    %2.1.7 Definition of the mirror of the Head Sail
    mirrorMain=Main;
    mirrorMain.Y_V=-Main.Y_V;
    mirrorMain.Y_C=-Main.Y_C;
    mirrorMain.wake_Y=-Main.wake_Y;
    mirrorMain.ny=-Main.ny;
    
%--------------------------------------------------------------------------    
%% No mirror - [Numerical solution of GAMMA and computation of Vmean]
%--------------------------------------------------------------------------
if mirror==0  
    %3 Numerical solution of GAMMA
    %------------------------------   
    %3.1 The matrix of influence coeficients 
    %3.1.1 Head influencing
        % Head on Head
        [BHead_on_Head] = get_InflCoefs (Head, Head);    
        % Head on Main
        [BHead_on_Main] = get_InflCoefs(Head,Main);
    %3.1.2 Main influencing
        % Main on Head
        [BMain_on_Head] = get_InflCoefs (Main, Head);  
        % Main on Main
        [BMain_on_Main] = get_InflCoefs (Main, Main);
                 
    B= [BHead_on_Head  BMain_on_Head;...   
        BHead_on_Main  BMain_on_Main]; 
    
     clear BHead_on_Head
     clear BHead_on_Main
     clear BMain_on_Head
     clear BMain_on_Main      
    %3.2 for each panel we express the perpendicular velocity (along Z axis)
    %due to the U inf      
     Head.AW_n=reshape(Head.AW_n,(MHead-1)*(NHead-1),1);
     Main.AW_n=reshape(Main.AW_n,(MMain-1)*(NMain-1),1);     
     AW_n=[Head.AW_n ; Main.AW_n;];
     
     %3.3 We solve the system and find the vortex strength of each panel
     GAMMA=B\-AW_n;
     Head.GAMMA=reshape( GAMMA(1:(MHead-1)*(NHead-1),1),MHead-1,NHead-1);
     Main.GAMMA=reshape( GAMMA(((MHead-1)*(NHead-1) +1):  end,1),MMain-1,NMain-1);
     Head.AW_n=reshape( Head.AW_n(1:(MHead-1)*(NHead-1),1),MHead-1,NHead-1);
     Main.AW_n=reshape( Main.AW_n(1:(MMain-1)*(NMain-1),1),MMain-1,NMain-1); 
     
     clear B
     clear AW_n
    %4 Computation of the Mean Velocity
    %-------------------------------------
    %4.1 The Influenced Velocities
    [Vx_indHead_on_Head,Vy_indHead_on_Head,Vz_indHead_on_Head ] = get_Vind(Head,Head);
    [Vx_indMain_on_Head,Vy_indMain_on_Head,Vz_indMain_on_Head ] = get_Vind(Main,Head);
    [Vx_indMain_on_Main,Vy_indMain_on_Main,Vz_indMain_on_Main ] = get_Vind(Main,Main);
    [Vx_indHead_on_Main,Vy_indHead_on_Main,Vz_indHead_on_Main ] = get_Vind(Head,Main);

    %4.2 The mean velocity on the sail (Vmean = Vinf+Vind )
    Head.Vmeanx = Head.AW_X + Vx_indHead_on_Head + Vx_indMain_on_Head;
    Head.Vmeany = 0         + Vy_indHead_on_Head + Vy_indMain_on_Head;
    Head.Vmeanz = Head.AW_Z + Vz_indHead_on_Head + Vz_indMain_on_Head;
    Main.Vmeanx = Main.AW_X + Vx_indMain_on_Main + Vx_indHead_on_Main;
    Main.Vmeany = 0         + Vy_indMain_on_Main + Vy_indHead_on_Main;
    Main.Vmeanz = Main.AW_Z + Vz_indMain_on_Main + Vz_indHead_on_Main;  
     
    clear Vx_indHead_on_Head
    clear Vy_indHead_on_Head
    clear Vz_indHead_on_Head
    clear Vx_indMain_on_Head
    clear Vy_indMain_on_Head
    clear Vz_indMain_on_Head
    clear Vx_indMain_on_Main
    clear Vy_indMain_on_Main
    clear Vz_indMain_on_Main
    clear Vx_indHead_on_Main
    clear Vy_indHead_on_Main
    clear Vz_indHead_on_Main
end
%--------------------------------------------------------------------------    
%% Mirror included - [Numerical solution of GAMMA and computation of Vmean]
%--------------------------------------------------------------------------  
if mirror==1   
    %3 Numerical solution of GAMMA
    %------------------------------    
    %3.1 The matrix of influence coeficients
    %3.1.1 Head influencing
        % Head on Head
        [BHead_on_Head] = get_InflCoefs (Head, Head);   
        % Head on Main
        [BHead_on_Main] = get_InflCoefs(Head,Main); 
        % Head on mirrorMain
        [BHead_on_mirrorMain] = get_InflCoefs(Head,mirrorMain);
        % Head on mirrorHead
        [BHead_on_mirrorHead] = get_InflCoefs (Head, mirrorHead);
    %3.1.2 Main influencing
        % Main on Head
        [BMain_on_Head] = get_InflCoefs (Main, Head);
        % Main on Main
        [BMain_on_Main] = get_InflCoefs (Main, Main);
        % Main on mirrorMain
        [BMain_on_mirrorMain] = get_InflCoefs (Main, mirrorMain);
        % Main on mirrorHead
        [BMain_on_mirrorHead] = get_InflCoefs (Main, mirrorHead);  
    %3.1.3 mirrorMain influencing
        % mirrorMain on Head
        [BmirrorMain_on_Head] = -BMain_on_mirrorHead;
        % mirrorMain on Main
        [BmirrorMain_on_Main] = - BMain_on_mirrorMain;
        % mirrorMain on mirrorMain
        [BmirrorMain_on_mirrorMain] = -BMain_on_Main;
        % mirrorMain on mirrorHead
        [BmirrorMain_on_mirrorHead] = -BMain_on_Head;
    %3.1.4 mirrorHead influencing
        % mirrorHead on Head
        [BmirrorHead_on_Head] = - BHead_on_mirrorHead;
        % mirrorHead on Main
        [BmirrorHead_on_Main] = - BHead_on_mirrorMain;
        % mirrorHead on mirrorMain
        [BmirrorHead_on_mirrorMain] = - BHead_on_Main;
        % mirrorHead on mirrorHead
        [BmirrorHead_on_mirrorHead] = - BHead_on_Head;
    
    B= [BHead_on_Head         BMain_on_Head         BmirrorMain_on_Head         BmirrorHead_on_Head;...
        BHead_on_Main         BMain_on_Main         BmirrorMain_on_Main         BmirrorHead_on_Main;...
        BHead_on_mirrorMain   BMain_on_mirrorMain   BmirrorMain_on_mirrorMain   BmirrorHead_on_mirrorMain;...
        BHead_on_mirrorHead   BMain_on_mirrorHead   BmirrorMain_on_mirrorHead   BmirrorHead_on_mirrorHead];
 
    %3.2 for each panel we express the perpendicular velocity (along Z axis)
    % due to the U inf
     Head.AW_n=reshape(Head.AW_n,(MHead-1)*(NHead-1),1);
     Main.AW_n=reshape(Main.AW_n,(MMain-1)*(NMain-1),1);
     mirrorMain.AW_n=reshape(mirrorMain.AW_n,(MMain-1)*(NMain-1),1); 
     mirrorHead.AW_n=reshape(mirrorHead.AW_n,(MHead-1)*(NHead-1),1); 
     AW_n=[Head.AW_n ; Main.AW_n;mirrorMain.AW_n;mirrorHead.AW_n];
         
     clear BHead_on_Head
     clear BmirrorHead_on_Head
     clear BmirrorMain_on_Head
     clear BMain_on_Head
     clear BHead_on_mirrorHead
     clear BmirrorHead_on_mirrorHead
     clear BmirrorMain_on_mirrorHead
     clear BMain_on_mirrorHead
     clear BHead_on_mirrorMain
     clear BmirrorHead_on_mirrorMain
     clear BmirrorMain_on_mirrorMain
     clear BMain_on_mirrorMain
     clear BHead_on_Main
     clear BmirrorHead_on_Main
     clear BmirrorMain_on_Main
     clear BMain_on_Main

     %3.3 We solve the system and find the vortex strength of each panel
     GAMMA=B\-AW_n;
     Head.GAMMA=reshape( GAMMA(1:(MHead-1)*(NHead-1),1),MHead-1,NHead-1);
     Main.GAMMA=reshape( GAMMA(((MHead-1)*(NHead-1) +1):  ((MHead-1)*(NHead-1) + (MMain-1)*(NMain-1)),1),MMain-1,NMain-1);
     Head.AW_n=reshape( Head.AW_n(1:(MHead-1)*(NHead-1),1),MHead-1,NHead-1);
     Main.AW_n=reshape( Main.AW_n(1:(MMain-1)*(NMain-1),1),MMain-1,NMain-1);
     mirrorMain.GAMMA=-Main.GAMMA;
     mirrorHead.GAMMA=-Head.GAMMA;
     mirrorHead.AW_n=Head.AW_n;
     mirrorMain.AW_n=Main.AW_n;
     
     clear B
     clear AW_n
    %4 Computation of the Mean Velocity
    %-------------------------------------
    %4.1 The Influenced Velocities
    [Vx_indHead_on_Head,Vy_indHead_on_Head,Vz_indHead_on_Head ] = get_Vind(Head,Head);
    [Vx_indMain_on_Head,Vy_indMain_on_Head,Vz_indMain_on_Head ] = get_Vind(Main,Head);
    [Vx_indmirrorMain_on_Head,Vy_indmirrorMain_on_Head,Vz_indmirrorMain_on_Head ] = get_Vind(mirrorMain,Head);
    [Vx_indmirrorHead_on_Head,Vy_indmirrorHead_on_Head,Vz_indmirrorHead_on_Head ] = get_Vind(mirrorHead,Head);         
    [Vx_indHead_on_Main,Vy_indHead_on_Main,Vz_indHead_on_Main ] = get_Vind(Head,Main);
    [Vx_indMain_on_Main,Vy_indMain_on_Main,Vz_indMain_on_Main ] = get_Vind(Main,Main);
    [Vx_indmirrorMain_on_Main,Vy_indmirrorMain_on_Main,Vz_indmirrorMain_on_Main ] = get_Vind(mirrorMain,Main);
    [Vx_indmirrorHead_on_Main,Vy_indmirrorHead_on_Main,Vz_indmirrorHead_on_Main ] = get_Vind(mirrorHead,Main);
    
    %4.2 The mean velocity on the sail (Vmean = Vinf+Vind )
    Head.Vmeanx = Head.AW_X + Vx_indHead_on_Head + Vx_indMain_on_Head + Vx_indmirrorMain_on_Head + Vx_indmirrorHead_on_Head;
    Head.Vmeany = 0         + Vy_indHead_on_Head + Vy_indMain_on_Head + Vy_indmirrorMain_on_Head + Vy_indmirrorHead_on_Head;
    Head.Vmeanz = Head.AW_Z + Vz_indHead_on_Head + Vz_indMain_on_Head + Vz_indmirrorMain_on_Head + Vz_indmirrorHead_on_Head;
    Main.Vmeanx = Main.AW_X + Vx_indHead_on_Main + Vx_indMain_on_Main + Vx_indmirrorMain_on_Main + Vx_indmirrorHead_on_Main;
    Main.Vmeany = 0         + Vy_indHead_on_Main + Vy_indMain_on_Main + Vy_indmirrorMain_on_Main + Vy_indmirrorHead_on_Main;
    Main.Vmeanz = Main.AW_Z + Vz_indHead_on_Main + Vz_indMain_on_Main + Vz_indmirrorMain_on_Main + Vz_indmirrorHead_on_Main;
    
    clear Vx_indHead_on_Head
    clear Vy_indHead_on_Head
    clear Vz_indHead_on_Head
    clear Vx_indMain_on_Head
    clear Vy_indMain_on_Head
    clear Vz_indMain_on_Head
    clear Vx_indmirrorMain_on_Head
    clear Vy_indmirrorMain_on_Head
    clear Vz_indmirrorMain_on_Head
    clear Vx_indmirrorHead_on_Head
    clear Vy_indmirrorHead_on_Head
    clear Vz_indmirrorHead_on_Head
    clear Vx_indHead_on_Main
    clear Vy_indHead_on_Main
    clear Vz_indHead_on_Main
    clear Vx_indMain_on_Main
    clear Vy_indMain_on_Main
    clear Vz_indMain_on_Main
    clear Vx_indmirrorMain_on_Main
    clear Vy_indmirrorMain_on_Main
    clear Vz_indmirrorMain_on_Main
    clear Vx_indmirrorHead_on_Main
    clear Vy_indmirrorHead_on_Main
    clear Vz_indmirrorHead_on_Main
end
    
%-------------------------------------------------------------------------
%% 5 Computation of the Loading
%--------------------------------------------------------------------------

%5.3 The pressure summation method
%---------------------------------
[Head] = get_FPS(Head,AWRef,rho);
[Main] = get_FPS(Main,AWRef,rho);

%5.4 The total forces, moments, coeficients, CE 
%-----------------------------------------------
%5.4.1 Total Force =  Forces + LE Force
FtotX = Head.FX + Main.FX;
FtotY = Head.FY + Main.FY;
FtotZ = Head.FZ + Main.FZ;

%5.3.2 Total Moment = Moments + LE Moment
MtotX = Head.MX + Main.MX;
MtotY = Head.MY + Main.MY;
MtotZ = Head.MZ + Main.MZ;

%5.4.4 The coefficients (for each sails on combined)
[Head.L,Head.Di] = get_LiftDrag (AWRef, Head.FX, Head.FY, Head.FZ);                       
Head.CL =  Head.L / (0.5* rho*AWRef.Mgn^2*sum(sum(Head.area)) );
Head.CDi = Head.Di / (0.5* rho*AWRef.Mgn^2*sum(sum(Head.area)) );

[Main.L,Main.Di] = get_LiftDrag (AWRef, Main.FX, Main.FY, Main.FZ);                       
Main.CL =  Main.L / (0.5*rho*AWRef.Mgn^2*sum(sum(Main.area)) );
Main.CDi = Main.Di / (0.5*rho*AWRef.Mgn^2*sum(sum(Main.area)) );

[L,Di] = get_LiftDrag (AWRef,FtotX,FtotY,FtotZ);                       
CL =  L / (0.5*rho*AWRef.Mgn^2*(sum(sum(Head.area)) + sum(sum(Main.area))) );
CDi = Di / (0.5*rho*AWRef.Mgn^2*(sum(sum(Head.area)) + sum(sum(Main.area))) );
Outputs.Cl=CL;
Outputs.Cdi=CDi;
% 5.6 Outputs
%------------

% Coeficients
Outputs.Surge=round(FtotX/(0.5*rho*AWRef.Mgn^2));
Outputs.Heave=round(FtotY/(0.5*rho*AWRef.Mgn^2));
Outputs.Sway=round(FtotZ/(0.5*rho*AWRef.Mgn^2));
Outputs.Roll=round(MtotX/(0.5*rho*AWRef.Mgn^2));
Outputs.Yaw=round(MtotY/(0.5*rho*AWRef.Mgn^2));
Outputs.Pitch=round(MtotZ/(0.5*rho*AWRef.Mgn^2));

% The Forces/Moments
FtotX = round(FtotX);
FtotY = round(FtotY);
FtotZ = round(FtotZ);
MtotX = round(MtotX);
MtotY = round(MtotY);
MtotZ = round(MtotZ);

%Forces and moments and Centre of pressure
Outputs.FX=FtotX;
Outputs.FY=FtotY;
Outputs.FZ=FtotZ;
Outputs.MX=MtotX;
Outputs.MY=MtotY;
Outputs.MZ=MtotZ;
Outputs.F_M_CE={[' '] ['X'] ['Y'] ['Z'];['F[N]'] [num2str(FtotX)] [num2str(FtotY)] [num2str(FtotZ)];['M[Nm]'] [num2str(MtotX)] [num2str(MtotY)] [num2str(MtotZ)];};
Outputs.WindProfile.Height=WindProfile(:,1);
Outputs.WindProfile.TWS=WindProfile(:,2);
Outputs.WindProfile.TWA=WindProfile(:,3);
Outputs.WindProfile.AWA=WindProfile(:,4);
Outputs.WindProfile.AWS=WindProfile(:,5);


%-------------------------------------------------------------------------

%% 6 Plots
%--------------------------------------------------------------------------

% % 6.1 Shapes + wakes
% %--------------------
% figure (2)
% cla
% hold on
% plot3(Head.X_V,Head.Y_V,Head.Z_V,'-b');
% plot3(Head.X_V',Head.Y_V',Head.Z_V','-b');
% plot3(Main.X_V,Main.Y_V,Main.Z_V,'-b');
% plot3(Main.X_V',Main.Y_V',Main.Z_V','-b');
% plot3(Head.wake_X,Head.wake_Y,Head.wake_Z,'-r');
% plot3(Main.wake_X,Main.wake_Y,Main.wake_Z,'-r');
% hold off
% view(0,90)
% axis('equal')
% xlabel('X [m]')
% ylabel('Y [m]')
% zlabel('Z [m]')

% 6.2 dCp
%--------
% figure (1)
% hold on
% cla
% colormap jet
% surf( Main.X_C, Main.Y_C, Main.Z_C, Main.dCp_C);
% surf( Head.X_C, Head.Y_C, Head.Z_C, Head.dCp_C);
% plot3( Head.wake_X, Head.wake_Y, Head.wake_Z, '-b');
% plot3(Main.wake_X, Main.wake_Y, Main.wake_Z, '-b');
% colorbar
% axis 'equal';
% axes=caxis;
% caxis([axes(1,1) axes(1,2)]);
% xlabel('X [m]')
% ylabel('Y [m]')
% zlabel('Z [m]')
% zoom reset
% hold off
Main.outputs=Outputs;
Head.outputs=Outputs;
result=[Head, Main];
end

